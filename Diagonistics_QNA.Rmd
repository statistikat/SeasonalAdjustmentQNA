---
title: "QNA_Saisonbereinigung"
author: "Angelika Meraner"
date: "`r Sys.Date()`"
output: html_document
---

```{r include=FALSE}
knitr::opts_chunk$set(comment = NA)
require(data.table)

told <- as.data.frame(oldres$output$regarima$residuals.stat[2])[,1:2]
setDT(told)
names(told) <- c("Statistic","P.value")
test.Type <- c("Normality","","","Independence","","Linearity")
told <- cbind(test.Type,told)
told[, Sig := ""]
told[P.value >= 0.1, Sig := "***"]
told[P.value < 0.1 & P.value >=0.05, Sig := "**"]

test.Type_more_info <- c("mean","skewness","kurtosis","ljung box (LBQ)","LBQ (res at seas lags)","LBQ (sq res)")
told <- cbind(told,test.Type_more_info)

tdef <- as.data.frame(newres$output$regarima$residuals.stat[2])[,1:2]
setDT(tdef)
names(tdef) <- c("Statistic","P.value")
test.Type <- c("Normality","","","Independence","","Linearity")
tdef <- cbind(test.Type,tdef)
tdef[, Sig := ""]
tdef[P.value >= 0.1, Sig := "***"]
tdef[P.value < 0.1 & P.value >=0.05, Sig := "**"]

ddef <- newres$output$diagnostics
dold <- oldres$output$diagnostics
# Stable seasonality
ddef$combined_test
dold$combined_test

# Residual seasonality
dnewres <- ddef$residuals_test[!names(ddef$residuals_test)%in%"Description"]
test.Type <- rownames(dnewres)
setDT(dnewres)
dnewres <- cbind(test.Type,dnewres)
dnewres[, Sig := ""]
dnewres[P.value >= 0.1, Sig := "***"]
dnewres[P.value < 0.1 & P.value >=0.05, Sig := "**"]

doldres <- dold$residuals_test[!names(dold$residuals_test)%in%"Description"]
test.Type <- rownames(doldres)
setDT(doldres)
doldres <- cbind(test.Type,doldres)
doldres[, Sig := ""]
doldres[P.value >= 0.1, Sig := "***"]
doldres[P.value < 0.1 & P.value >=0.05, Sig := "**"]

dboth <- merge(doldres,dnewres,by="test.Type",suffixes = c("_old","_new"), sort = FALSE)


```

# `r paste({{i}},".",tsname)`

:::: {style="display: flex;"}

::: {}

# Old result (`oldres`)

### Arima Model

```{r warning=FALSE, message=FALSE, echo=FALSE}
cat(ifelse(oldres$output$decomposition$mode == "Multiplicative","log",oldres$output$decomposition$mode))
cat(paste0("(",paste0(oldres$output$regarima$arma,collapse= ", "),")"))
oldres$output$regarima$regression.coefficients
```

:::

::: {}

# New result (`newres`)

### Arima Model

```{r warning=FALSE,message=FALSE, echo=FALSE}
cat(ifelse(newres$output$decomposition$mode == "Multiplicative","log",newres$output$decomposition$mode))
cat(paste0("(",paste0(newres$output$regarima$arma,collapse= ", "),")"))
newres$output$regarima$regression.coefficients
```

:::
:::: 

:::: {.columns}

::: {.column width="50%"}


```{r warning=FALSE,message=FALSE, echo=FALSE, out.width = '90%'}
try(oldres$plot(forecasts=FALSE))
```

:::

::: {.column width="50%"}


```{r warning=FALSE,message=FALSE, echo=FALSE, out.width = '90%'}
try(newres$plot(forecasts=FALSE))
```

:::
::::

:::: {style="display: flex;"}

::: {}

### Residuals (old)

```{r message=FALSE, warning=FALSE, echo=FALSE}
told
```

:::

::: {}

### Residuals (new)

```{r message=FALSE, warning=FALSE, echo=FALSE}
tdef
```

:::
::::

:::: {style="display: flex;"}

::: {}

### Stable seasonality (old)
Combined test in the entire series
```{r warning=FALSE,message=FALSE, echo=FALSE}
dold$combined_test
```

:::

::: {}

### Stable seasonality (new)
Combined test in the entire series
```{r warning=FALSE,message=FALSE, echo=FALSE}
ddef$combined_test
```

:::
::::

### Residual seasonality 

```{r warning=FALSE,message=FALSE, echo=FALSE}
options(width = 150)
dboth
```

# Commentary:
### Residuals:
#### Normality
H0 (normality of residuals) is not rejected at significance levels >= 0.05\
Signif. codes: 0.1 \`\*\*\*\´ 0.05 \`\*\*\´

#### Independence
Ljung-Box: \
$H_{0}$: The data is not correlated (i.e. the correlations in the population from which the sample is taken are 0, so that any observed correlations in the data result from randomness of the sampling process).\
$H_{a}$: The data exhibit serial correlation.

H0 (independence of residuals) is not rejected at significance levels >= 0.05\
Signif. codes: 0.1 \`\*\*\*\´ 0.05 \`\*\*\´

#### Linearity
H0 (no conditional heteroscedasticity of residuals) is not rejected at significance levels >= 0.05\
Signif. codes: 0.1 \`\*\*\*\´ 0.05 \`\*\*\´

### Stable Seasonality:
$H_{0}$: no stable seasonality.\
If the null hypothesis of no stable seasonality is rejected significance level < 0.001 then the series is considered to be seasonal. \
https://sylwiagrudkowska.github.io/JDemetra-documentation/pages/theory/Tests_combined.html
https://github.com/rjdverse/rjdemetra/blob/90f8ff6e46e642e4c8fe064913118e19e6c96f7d/R/diagnostics.R#L28


### Residual Seasonality:
$H_{0}$: no seasonality.\
The null hypothesis that there is no seasonality in the series is not rejected at significance levels >= 0.1(?? can't find documentation)\
The QS diagnostic (Maravall 2012) for example looks for positive seasonal autocorrelation in a series, in
order to test the null hypothesis that there is no seasonality in the series. \
https://sylwiagrudkowska.github.io/JDemetra-documentation/pages/sa/diagnostics/residualseasonality.html


